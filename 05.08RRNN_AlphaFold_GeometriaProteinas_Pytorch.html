
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>AlphaFold. Geometria de las Proteinas &#8212; Introducción al Aprendizaje Automático</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/proof.css?v=ca93fcec" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '05.08RRNN_AlphaFold_GeometriaProteinas_Pytorch';</script>
    <link rel="icon" href="_static/EscUpm.jpg"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Identificación 3D con PointNet" href="05.09RRNN_PointNet_con_Pytorch.html" />
    <link rel="prev" title="Maqueta de red neuronal convolucional" href="05.07B_RRNN_Convoluciones_Maqueta.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="introAA.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/LOGOTIPOcolorPNG.png" class="logo__image only-light" alt="Introducción al Aprendizaje Automático - Home"/>
    <script>document.write(`<img src="_static/LOGOTIPOcolorPNG.png" class="logo__image only-dark" alt="Introducción al Aprendizaje Automático - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="introAA.html">
                    Bienvenida
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="01_IntroduccionIntro.html">Presentación</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="01.1_Introduccion.html">Introducción al Aprendizaje Automático</a></li>
<li class="toctree-l2"><a class="reference internal" href="01.2_InstalacionJupyter.html">Instalación de Python y Cuadernos Jupyter</a></li>
<li class="toctree-l2"><a class="reference internal" href="01.3_EjemplosdePythonparaaprenderaprogramar.html">Repaso de programación en Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="01.4_InstalacionLibrerias.html">Instalación de Librerías</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="02_ClasificacionIntro.html">Clasificación</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="02.1_MetodosdeClasificacion-Naive-Bayes.html">Clasificación naive-Bayes</a></li>
<li class="toctree-l2"><a class="reference internal" href="02.2_MetodosdeClasificacion-Naive-Bayes-RNA-SPLICING.html">Clasificación naive-Bayes de secuencias de ADN</a></li>
<li class="toctree-l2"><a class="reference internal" href="02.3_MetodosdeClasificacion-Ratioseindicadores.html">Ratios e indicadores</a></li>
<li class="toctree-l2"><a class="reference internal" href="02.4_MetodosdeClasificacion-ArbolesdeDecision.html">Árboles de Decisión</a></li>
<li class="toctree-l2"><a class="reference internal" href="02.6_Clasificacion-Ejercicioparaentregarsobrevariedadevinicolas.html">Ejercicio sobre variedades vínicolas</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="03_ClusteringIntro.html">Clustering</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="03.0_ClusteringUtilidades.html">Utilidad para Clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.1_Clustering-K-Means.html">Aprendizaje no supervisado. Clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.2_Clustering-Jerarquicosydensidad.html">Clustering Jerárquico, Densidad y Mean-Shift</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.3_Clustering_Analisis_Microarrays.html">Clustering. Análisis de microarrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.4_ClusteringEntregaDiabetesIndiosPima.html">Ejercicio de Clustering con fichero de diabetes (indios Pima)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="04_CadenasMarkovIntro.html">Cadenas de Markov</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="04.00_ObjetivoAnalisisSecuencias.html">Análisis de Secuencias: Objetivo</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.01_CadenasMarkovIntroduccion.html">Ejemplo inicial de cadena de Markov</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.01B_CadenasMarkovEjemplos.html">Otros ejemplos</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.02_CadenasMarkovResultados.html">Cadenas de Markov</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.02B_CadenasMarkovAsintotico.html">Comportamiento asintótico</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.03_CadenasMarkovModelosSecuencias.html">Cadenas de Markov como modelos de secuencias</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.04_ModelosMarkovOcultos.html">Modelos de Markov Ocultos</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.05_AnalisisHMM.html">Análisis de HMM</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.06_CadenasMarkov.html">Práctica 1: cadenas de Markov como Modelos de Secuencias</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.07_CadenasDeMarkovOcultas.html">Práctica 2: predicción de estructuras secundarias en proteínas</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.08_MarkovExtra.html">Entrega: secuencia más probable en una cadena de Markov.</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="05_rnnIntro.html">Redes Neuronales</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="05.0_Redes_Neuronales_Utilidades.html">Redes Neuronales Utilidades</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.1_RedesNeuronalesIntroduccion.html">Redes Neuronales Introducción</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.2_RedesNeuronales-ModeloBicapa.html">Redes Neuronales - Modelo Bicapa</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.3_RedesNeuronales-ModeloMultiCapa.html">Redes Neuronales - Modelo MultiCapa</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.4_RRNN-Ejercicio%20Wine.html">RRNN - Ejercicio Wine</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.5_RRNN_Analisis_Microarrays.html">RRNN Análisis de microarrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.6_RRNN-EjerciciosplicingparaEntrega.html">RNNN - Ejercicio splicing para Entrega</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.07A_RRNN_Convoluciones_CIFAR_10.html">Redes Neuronales Convoluciones con arquitectura Pytorch</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.07B_RRNN_Convoluciones_Maqueta.html">Maqueta de red neuronal convolucional</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">AlphaFold. Geometria de las Proteinas</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.09RRNN_PointNet_con_Pytorch.html">Identificación 3D con PointNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.10RRNN_Segmentar_Imagenes_2D.html">Segmentación de imágenes 2D con redes completamente convolucionales</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.11RRNN_Segmentar_Imagenes_2D_cityscapes.html">Segmentación de imágenes 2D con redes completamente convolucionales (conjunto Cityscapes)</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.12RRNN_Segmentacion_Instancias_2D_MaskRCNN.html">Segmentación de instancias 2D con Mask R-CNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.13RRNN_Implementar_una_red_LSTM_con_pytorch_series_temporales.html">Implementar una Red Neuronal para una Serie Temporal (LSTM)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="06_mapasAutoorganizativosIntro.html">Mapas Autoorganizativos</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="06.01_SOM_VisualizarDatos.html">Motivación: visualizar datos multidimensionales</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.02_SOM_MapaAutoorganizativo.html">Mapas autoorganizativos</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.03_SOM_Algoritmo.html">El Algoritmo <em>SOM</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="06.04_SOM_AplicacionesBiotecnologia.html">Aplicaciones en biotecnología</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.05_SOM_EjemploPoblacionIrlanda.html">Ejemplo con Datos demográficos</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.06_SOM_EjemploColoresRGB.html">Ejemplo con Colores RGB</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.07_SOM_Practica1_Python_v5.html">Práctica 1: Algoritmo SOM de Kohonen en una dimension</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.08_SOM_Practica2_RegionesVinicolas_Python.html">Práctica 2. <em>Clustering</em> de regiones vinícolas</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.09_SOM_Practica3_SOMClasificador_Python.html">Práctica 2. Continuación</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.10_SOM_Practica4_TareaExtra.html">Entrega</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="07_algoritmosGeneticosIntro.html">Algoritmos Genéticos</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="07.01_GA1.html">Algoritmos Genéticos</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.02_GA2.html">Los algoritmos genéticos</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.03_GA3.html">El Algoritmo Genético</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.04_GA4_Robbie.html">Robbie el Robot Recogebasura</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.05_GA5_Practica1.html">Práctica 1: Pasos elementales del GA</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.06_GA6_Practica2_OptimizarFuncion.html">Práctica 2: Optimizar función</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.07_GA7_Practica3_TSP.html">Práctica 3: <em>Travelling Salesman</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="07.08_GA8_Practica_Extra.html">Entrega: <em>Animula Vagula Blandula</em></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Bibliografia.html">Bibliografía</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/05.08RRNN_AlphaFold_GeometriaProteinas_Pytorch.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>AlphaFold. Geometria de las Proteinas</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduccion">Introducción</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#alcance-del-cuaderno">Alcance del cuaderno</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creacion-de-datasets-y-dataloaders">Creación de Datasets y Dataloaders</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#definicion-de-las-caracteristicas-del-modelo">Definición de las características del modelo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lectura-de-los-ficheros-tfrec-pkl-y-config">Lectura de los ficheros tfrec, pkl y config</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dibujo-de-distogramas">Dibujo de distogramas</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#funcion-de-carga-de-datos-dataset">Función de carga de datos (Dataset)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#se-cargan-los-datos-disponibles">Se cargan los datos disponibles</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#definicion-del-modelo">Definición del Modelo</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#capa-de-convoluciones-que-se-inserta-en-los-bloques-residuales">Capa de convoluciones que se inserta en los bloques residuales</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bloque-de-capas-residuales">Bloque de capas residuales</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clase-principal">Clase principal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#se-crea-un-objeto-con-el-modelo">Se crea un objeto con el modelo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#se-carga-el-modelo-pre-entrenado">Se carga el modelo pre-entrenado</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#se-evalua-el-dataset-contra-el-modelo">Se evalua el dataset contra el modelo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#se-dibujan-los-resultados">Se dibujan los resultados</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="alphafold-geometria-de-las-proteinas">
<h1>AlphaFold. Geometria de las Proteinas<a class="headerlink" href="#alphafold-geometria-de-las-proteinas" title="Link to this heading">#</a></h1>
<section id="introduccion">
<h2>Introducción<a class="headerlink" href="#introduccion" title="Link to this heading">#</a></h2>
<p>El problema del <strong>plegamiento de proteínas</strong> se refiere a cómo las proteínas se presentan en sus formas finales y dicta su estructura tridimensional a partir de la secuencia de aminoácidos.</p>
<p>La secuencia de proteínas, el orden de los aminoácidos y las propiedades electromagnéticas de cada aminoácido determinan la forma final de las proteínas. Además, dado que hay 20 tipos diferentes de aminoácidos, la secuencia de proteínas se puede expresar simplemente como una combinación de 20 símbolos únicos.</p>
<p>El problema del plegamiento de proteínas se ha tratado con varios métodos <strong>computacionales utilizando modelos basados en plantillas</strong> (basados en la idea de que secuencias similares conducen a estructuras similares), <strong>enfoques de ensamblaje de fragmentos</strong>, etc. En el último enfoque, una secuencia de proteínas objetivo se deconstruyó en pequeños fragmentos superpuestos, y la base de datos se examinó para identificar estructuras conocidas de secuencias de fragmentos similares que luego se ensamblan en una predicción de longitud completa. Aunque el último método demostró ser exitoso, se considera ineficiente ya que lleva demasiado tiempo de computación.</p>
<p>Aquí es donde aparecen los “<strong>datos de covariación evolutiva</strong>” y mejoran la precisión de las predicciones de estructura. AlphaFold 1 se define como un “método dependiente de la coevolución”.</p>
<p><strong>Coevolución de proteínas</strong></p>
<p>Los puntos de contacto juegan un papel crucial en el mantenimiento de la estructura 3D general de las proteínas. Las interacciones electroquímicas de un <strong>par de aminoácidos forman estos puntos de contacto</strong>. Sin embargo, la mutación puede ocurrir y cambiar uno de estos aminoácidos durante la evolución, y en consecuencia cambiar la estructura y función de la proteína. Es por eso que, en general, cuando uno de estos aminoácidos se modifica, el otro par también se ajusta para mantener propiedades electromagnéticas similares que mantendrán la forma de la proteína sin cambios. En esta situación, decimos que un par de aminoácidos <strong>coevolucionaron</strong>. Después de un reemplazo, la coevolución tiende a equilibrar la proteína al cambio.</p>
<p>si desea buscar interacciones de aminoácidos relevantes que contribuyan a la estructura (y función) de las proteínas, debe buscar pares de aminoácidos que hayan coevolucionado.</p>
<p>La covariación de aminoácidos se puede encontrar analizando un gran número de bases de datos de secuencias. La <strong>alineación de secuencias múltiples o programas MSA</strong> se utilizan para alinear varias secuencias de aminoácidos de familias de proteínas de diferentes especies y examinar la correlación entre los aminoácidos. Este análisis informa la correlación en pares de posiciones que pueden contribuir a la forma de la proteína.</p>
<p>AlphaFold no solo busca el punto de contacto, sino que predice la <strong>distancia entre los aminoácidos</strong> en una proteína y la <strong>distribución de probabilidad</strong> de la distancia predicha.</p>
<p>En la siguiente imagen del artículo AlphaFold 1 (<span id="id1">[<a class="reference internal" href="Bibliografia.html#id65" title="Andrew W Senior, Richard Evans, John Jumper, James Kirkpatrick, Laurent Sifre, Tim Green, Chongli Qin, Augustin Žídek, Alexander WR Nelson, Alex Bridgland, and others. Improved protein structure prediction using potentials from deep learning. Nature, 577(7792):706–710, 2020.">Senior <em>et al.</em>, 2020</a>]</span>) se puede ver que cada píxel en el mapa de distancia representa una distribución de probabilidad. DeepMind, la empresa desarrolladora de AlphaFold, llama a esto un distograma. En concreto es el <strong>distograma de la proteina CASP T0955</strong> (longitud = 41):</p>
<a class="reference internal image-reference" href="_images/alphafold_net2.png"><img alt="_images/alphafold_net2.png" src="_images/alphafold_net2.png" style="width: 550px;" /></a>
<ul class="simple">
<li><p><strong>(a)</strong> Estructura nativa que muestra distancias inferiores a 8 <span class="math notranslate nohighlight">\(\mathring{A}\)</span> desde <span class="math notranslate nohighlight">\(C_{\beta}\)</span> del residuo 29.</p></li>
<li><p><strong>(b)</strong> Distancia de inter-residuos nativos.</p></li>
<li><p><strong>(c)</strong> La moda de las predicciones de distancia, resaltando el residuo 29.</p></li>
<li><p><strong>(d)</strong> Las distribuciones de probabilidad previstas para las distancias del residuo 29 a todos los demás residuos.</p></li>
</ul>
<p>Puede verse que las modas de la distribución (c) coinciden estrechamente con las distancias reales (b).</p>
<p><strong>AlphaFold 1</strong> representa estructuras 3D como un <strong>par de ángulos de torsión entre aminoácidos</strong>. Incluso cuando una proteína está en un estado plegado, los bloques básicos, la estructura del aminoácido permanece sin cambios. Sin embargo, el ángulo de torsión entre un aminoácido y el otro cambia. AlphaFold calcula la <strong>distribución de probabilidad de los ángulos de torsión</strong> de los aminoácidos.</p>
<a class="reference internal image-reference" href="_images/alphafold_net4.png"><img alt="_images/alphafold_net4.png" src="_images/alphafold_net4.png" style="width: 500px;" /></a>
<p>En el <strong>primer paso</strong>, AlphaFold 1 recibe datos y secuencia de aminoácidos de una proteína objetivo y entrena una red convolucional (con conjunto de datos PDB) para encontrar:</p>
<ol class="arabic simple">
<li><p>El <strong>distograma</strong> de la proteína</p></li>
<li><p>La distribución de probabilidad del ángulo de <strong>torsión</strong>.</p></li>
</ol>
<a class="reference internal image-reference" href="_images/alphafold_net5.png"><img alt="_images/alphafold_net5.png" src="_images/alphafold_net5.png" style="width: 500px;" /></a>
<p>En el <strong>segundo paso</strong>, AlphaFold 1 ejecuta una iteración de <strong>gradiente descenso de la función potencial</strong> de la proteina.</p>
<p>Construye una <strong>función potencial específicia</strong></p>
<div class="math notranslate nohighlight">
\[V(\phi,\psi)=V_{distance}(\phi,\psi)+V_{torsion}(\phi,\psi)+V_{score2-smooth}(\phi,\psi)\]</div>
<p>A partir de:</p>
<ol class="arabic simple">
<li><p><strong>Potencial de distancia</strong>(<span class="math notranslate nohighlight">\(V_{distance}(\phi,\psi)\)</span>): cruzando los angulos de torsión y el distograma predicho por la red convolucional.</p></li>
<li><p><strong>Potencial geométrico</strong>(<span class="math notranslate nohighlight">\(V_{torsion}(\phi,\psi)\)</span>): cruzando la estructura predicha inicialmente y distribución de torsión.</p></li>
<li><p><strong>Potencial suave</strong>(<span class="math notranslate nohighlight">\(V_{score2-smooth}(\phi,\psi)\)</span>): La estructura de aminoácidos tiene una estructura de columna vertebral y cadenas laterales. Sin embargo, cuando AlphaFold 1 predice la estructura inicial, se hace utilizando solo la estructura de la columna vertebral, y no se considera si existe o no una cadena lateral. Por lo tanto, AlphaFold incorpora el término <strong>Van der Waals</strong> para evitar choques estéricos, porque los residuos no chocan entre sí. Esto se conoce como el <strong>potencial suave</strong>.</p></li>
</ol>
<a class="reference internal image-reference" href="_images/alphafold_net6.png"><img alt="_images/alphafold_net6.png" src="_images/alphafold_net6.png" style="width: 700px;" /></a>
<p>El <strong>último paso</strong> es encontrar por iteración una solución óptima que minimice la función potencial correspondiente. AlphaFold 1 utiliza la minimización del <strong>descenso de gradiente</strong> para obtener estructuras de proteínas bien empaquetadas. La estructura de <strong>menor potencial</strong> se almacena como la <strong>mejor solución</strong> de la iteración como una de las respuestas esperadas.</p>
<p>Si solo confía en la estructura inicial, puede caer en mínimos locales, por lo que también se agregará <strong>ruido</strong>. El valor óptimo de esa iteración también se almacena como una respuesta esperada.</p>
<a class="reference internal image-reference" href="_images/alphafold_net7.png"><img alt="_images/alphafold_net7.png" src="_images/alphafold_net7.png" style="width: 400px;" /></a>
<p>La predicción de la estructura de proteínas tiene como objetivo determinar la forma tridimensional de una proteína a partir de su secuencia de aminoácidos. En 2018 <strong>AlphaFold 1</strong> (<span id="id2">[<a class="reference internal" href="Bibliografia.html#id65" title="Andrew W Senior, Richard Evans, John Jumper, James Kirkpatrick, Laurent Sifre, Tim Green, Chongli Qin, Augustin Žídek, Alexander WR Nelson, Alex Bridgland, and others. Improved protein structure prediction using potentials from deep learning. Nature, 577(7792):706–710, 2020.">Senior <em>et al.</em>, 2020</a>]</span>) participó junto a 97 grupos en una competición bienal para predecir la estructura de 84 secuencias de proteinas cuya estructura se determinó experimentalmente.</p>
<p>Dividieron las proteinas en 104 dominios y clasificaron cada uno como supceptible al modelado basado en plantillas (TBM), modelado libre (FM) o intermedio (TBM/FM). AlphaFold predijo más dominios FM con alta precisión que cualquier otro sistema.</p>
<a class="reference internal image-reference" href="_images/alphafold_net1.png"><img alt="_images/alphafold_net1.png" src="_images/alphafold_net1.png" style="width: 700px;" /></a>
<p>El proceso de plegado para el objetivo de CASP13 identificado como <strong>T0986s2</strong> (cuya longitud es L=155) es:</p>
<ul class="simple">
<li><p><strong>(a)</strong> Pasos de la predicción de estructuras.</p></li>
<li><p><strong>(b)</strong> La red neuronal predice todo el distograma <strong>LxL</strong> en función de las características de MSA, acumulando predicciones separadas para residuos 64x64</p></li>
<li><p><strong>(c)</strong> Iteración de gradiente descenso (1200 pasos) con la puntuación TM y RMSD graficadas contra el número de pasos. También se muestra la estructura secundaria (de SST30) (hélice en azul, hebra en rojo) junto con la estructura secundaria nativa (SS), las probabilidades de predicción de la estructura secundaria de la red y la incertidumbre en las predicciones del ángulo de torsión (<span class="math notranslate nohighlight">\(K^{-1}\)</span> de la distribución de von Mises).</p></li>
<li><p><strong>(d)</strong> muestra la primera presentación final superpuesta a la estructura nativa (en gris).</p></li>
<li><p><strong>(e)</strong> muestra el puntaje TM promedio (a través del conjunto de prueba, n = 377) de la estructura de potencial más bajo contra el número de repeticiones de descenso de gradiente (escala logarítmica).</p></li>
</ul>
<p>El componente central de AlphaFold es una red neuronal convolucional que se entrena en estructuras PDB para
predecir las distancias <span class="math notranslate nohighlight">\(d_{ij}\)</span> entre los átomos de <span class="math notranslate nohighlight">\(C_{\beta}\)</span> de los pares, <span class="math notranslate nohighlight">\(ij\)</span>, de los 96 residuos de una proteína. Basado en una representación de la secuencia de aminoácidos de la proteína, <span class="math notranslate nohighlight">\(\mathcal{S}\)</span>, y características derivadas de la secuencia MSA, la red, de estructura similar a las utilizadas para el reconocimiento de imágenes, predice una distribución de probabilidad discreta <span class="math notranslate nohighlight">\(P(d_{ij} | \mathcal{S}, MSA(\mathcal{S}))\)</span> para cada par <span class="math notranslate nohighlight">\(ij\)</span> en una región de residuos de 64x64.</p>
<p>El conjunto completo de predicciones de distribución de distancia se construye promediando predicciones para regiones superpuestas y se denomina <strong>distograma</strong> (”<em>histograma de distancias</em>”).</p>
<p>Para realizar estructuras que se ajusten a las predicciones de distancia, se contruye una <span class="math notranslate nohighlight">\(V_{distancia}\)</span> de potencial suave, ajustando un sp-line a las probabilidades logarítmicas negativas y sumando todos los pares de residuos. Se parametrizan las estructuras proteicas por los ángulos de torsión del esqueleto <span class="math notranslate nohighlight">\((\phi, \psi)\)</span> de todos los residuos y se construye una función diferenciable de la geometría de la proteina <span class="math notranslate nohighlight">\(x=G(\phi, \psi)\)</span> para calcular las coordenadas de <span class="math notranslate nohighlight">\(C_{\beta}\)</span>, <span class="math notranslate nohighlight">\(x\)</span>, y sus distancias inter-residuo, <span class="math notranslate nohighlight">\(d_{ij}=|x_i-x_j|\)</span>, para cada estructura, y expresar <span class="math notranslate nohighlight">\(V_{distancia}\)</span> como una función de <span class="math notranslate nohighlight">\(\phi\)</span> y <span class="math notranslate nohighlight">\(\psi\)</span>.</p>
<p>Para una proteína con <span class="math notranslate nohighlight">\(L\)</span> residuos, este potencial acumula <span class="math notranslate nohighlight">\(L^2\)</span> términos de predicciones de distribución marginal, donde <span class="math notranslate nohighlight">\(L\)</span> es la longitud de la proteina.</p>
<p>La distribución de referencia modela las distribuciones de distancia <span class="math notranslate nohighlight">\(P(d_{ij} | L)\)</span> independientemente de la secuencia de la proteína y se calcula entrenando una versión pequeña de la red neuronal con las predicciones de la distancia en las mismas estructuras, sin características de entrada de secuencia o <strong>MSA</strong>.</p>
<p>Se entrena una cabecera de salida separada de la red de predicción de contacto para predecir distribuciones de probabilidad discretas de los ángulos de torsión de la columna vertebral <span class="math notranslate nohighlight">\(P(\phi_i, \psi_j | S, MSA(S))\)</span>. Después de ajustar una distribución de von Mises, esto se usa para agregar un término de modelado de torsión suave <span class="math notranslate nohighlight">\(V_{torsion}\)</span> al potencial:</p>
<div class="math notranslate nohighlight">
\[V_{torsion} = - \displaystyle\sum log p_{vonMises} (\phi_i, \psi_j | S, MSA(S)) \]</div>
<p>Finalmente, para evitar choques estéricos, se agrega el <span class="math notranslate nohighlight">\(V_{score2-suave}\)</span> de Rosetta al potencial, ya que incorpora un término de van der Waals.</p>
<p><span id="id3">[<a class="reference internal" href="Bibliografia.html#id65" title="Andrew W Senior, Richard Evans, John Jumper, James Kirkpatrick, Laurent Sifre, Tim Green, Chongli Qin, Augustin Žídek, Alexander WR Nelson, Alex Bridgland, and others. Improved protein structure prediction using potentials from deep learning. Nature, 577(7792):706–710, 2020.">Senior <em>et al.</em>, 2020</a>]</span> proporcionan un código ejecutado con la arquitectura Tensorflow que permite predecir proteinas estructuradas en CASP13. Es la versión oficial inicial o <strong>AlphaFold 1</strong>, el enlace es:</p>
<p>https://github.com/deepmind/deepmind-research/tree/master/alphafold_casp13</p>
<p>Una <strong>versión 2</strong> se encuentra en:</p>
<p>https://github.com/deepmind/alphafold</p>
<p>Hemos utilizado una versión de  <strong>AlphaFold 1 en PyTorch</strong>, con las adaptaciones necesarias a Jupyter. Que puede ejecutarse tanto en CPU, como GPU:</p>
<p>https://github.com/Urinx/alphafold_pytorch</p>
<p>Únicamente la función de lectura de ficheros TFREC (<strong>tfrec_read</strong>) está sin migrar a PyTorch y requiere de la instalación de TensorFlow.</p>
<p>No aparece publicada la función de pérdida, por lo que no es posible construir el modelo de entrenamiento. Por contra <span id="id4">[<a class="reference internal" href="Bibliografia.html#id65" title="Andrew W Senior, Richard Evans, John Jumper, James Kirkpatrick, Laurent Sifre, Tim Green, Chongli Qin, Augustin Žídek, Alexander WR Nelson, Alex Bridgland, and others. Improved protein structure prediction using potentials from deep learning. Nature, 577(7792):706–710, 2020.">Senior <em>et al.</em>, 2020</a>]</span> proporcionan los modelos entrenados en:</p>
<p>http://bit.ly/alphafold-casp13-weights</p>
<section id="alcance-del-cuaderno">
<h3>Alcance del cuaderno<a class="headerlink" href="#alcance-del-cuaderno" title="Link to this heading">#</a></h3>
<p>El alcance del cuaderno es una versión abreviada del código abierto que muestran los autores de <strong>AlphaFold 1</strong>, donde únicamente se modela el <strong>primer paso del algoritmo hasta obtener los distogramas</strong>.</p>
<p>Esta versión abreviada se ciñe a la rutina <strong>run_eval</strong> de https://github.com/deepmind/deepmind-research/tree/master/alphafold_casp13, no implementado la ejecución ensamblada contra varias que aparece en <strong>run_ensamble</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">googleColaboratory</span><span class="o">=</span><span class="kc">False</span>
<span class="n">modoEvaluacion</span><span class="o">=</span><span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">googleColaboratory</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
    <span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/drive/&#39;</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/content/drive/MyDrive/Colab Notebooks/data/alphafold&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">googleColaboratory</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./data/alphafold&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\valer_z\ownCloud - VALERIANO MENDEZ FUENTES@drive.upm.es\AA\jupyterbook\bookIAA\data\alphafold
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="creacion-de-datasets-y-dataloaders">
<h2>Creación de Datasets y Dataloaders<a class="headerlink" href="#creacion-de-datasets-y-dataloaders" title="Link to this heading">#</a></h2>
<section id="definicion-de-las-caracteristicas-del-modelo">
<h3>Definición de las características del modelo<a class="headerlink" href="#definicion-de-las-caracteristicas-del-modelo" title="Link to this heading">#</a></h3>
<p>El modelo incorpora las siguientes características:</p>
<ul class="simple">
<li><p><strong>aatype</strong> : Una codificación activa de tipos de aminoácidos. La asignación es ARNDCQEGHILKMFPSTWYVX -&gt; rango (21).</p></li>
<li><p><strong>alpha_mask</strong> : Máscara para alpha_positions.</p></li>
<li><p><strong>alpha_positions</strong> : (x, y, z) Coordenadas alfa de carbono.</p></li>
<li><p><strong>beta_mask</strong> : Máscara para beta_positions.</p></li>
<li><p><strong>beta_positions</strong> : (x, y, z) Coordenadas beta de carbono.</p></li>
<li><p><strong>between_segment_residues</strong> : El número de residuos entre segmentos (BSR) en la siguiente posición. P.ej. ABCXXD (XX es BSR) sería [0,0,2,0].</p></li>
<li><p><strong>chain_name</strong> : El nombre de la cadena. P.ej. ‘A’, ‘B’, …</p></li>
<li><p><strong>deletion_probability</strong> : La fracción de secuencias que tuvieron una eliminación en esta posición.</p></li>
<li><p><strong>domain_name</strong> :  El nombre de dominio.</p></li>
<li><p><strong>gap_matrix</strong> : (NR, NR, 1) Señal de covariación de los estados separados, esto da una indicación de la varianza inducida debido a los estados separados.</p></li>
<li><p><strong>hhblits_profile</strong> : float32 (NR, 22) Un perfil (distribución de probabilidad sobre tipos de aminoácidos) calculado usando HHBlits MSA. Codificación: 20 aminoácidos + ‘X’ + ‘-‘.</p></li>
<li><p><strong>hmm_profile</strong> : (NR, 30) El perfil HHBlits HHM (del archivo de salida -ohhm HHBlits). Los asteriscos en la salida se reemplazan por 0.0.</p></li>
<li><p><strong>key</strong> : La identificación única de la proteína.</p></li>
<li><p><strong>mutual_information</strong> : (NR, NR, 1) La información mutua corregida del producto promedio. Ver https://doi.org/10.1093/bioinformatics/btm604.</p></li>
<li><p><strong>non_gapped_profile</strong> : (NR, 21) Un perfil solo de aminoácidos (descontando espacios).</p></li>
<li><p><strong>num_alignments</strong> : (NR, 1) El número de alineaciones de secuencias múltiples de HHBlits. Tiene que ser repetido NR veces.</p></li>
<li><p><strong>num_efective_alignments</strong> : El número de alineaciones efectivas (neff al 62 % de similitud de secuencia).</p></li>
<li><p><strong>phi_angles</strong> : (NR, 1) Los ángulos phi.</p></li>
<li><p><strong>phi_mask</strong> : (NR, 1) Máscara para phi_angles.</p></li>
<li><p><strong>perfil</strong> : (NR, 21) Un perfil (distribución de probabilidad sobre tipos de aminoácidos) calculado usando PSI-BLAST. Equivalente a la salida de ChkParse.</p></li>
<li><p><strong>profile_with_prior</strong> : (NR, 22) Un perfil calculado usando HHBlits que tiene en cuenta las previas y la matriz Blosum. Ver ecuación 5 en https://doi.org/10.1093/nar/25.17.3389.</p></li>
<li><p><strong>profile_with_prior_without_gaps</strong> : (NR, 21) Igual que profile_with_prior pero sin espacios incluidos.</p></li>
<li><p><strong>pseudo_bias</strong> : (NR, 22) El sesgo calculado en el cálculo de pseudoverosimilitud de MSA.</p></li>
<li><p><strong>pseudo_frob</strong> : (NR, NR, 1) Norma de pseudoverosimilitud de Frobenius (brechas no incluidas). Similar a la salida de CCMPred.</p></li>
<li><p><strong>pseudolikelihood</strong> : (NR, NR, 484) Los pesos calculados en el cálculo de pseudoverosimilitud de MSA.</p></li>
<li><p><strong>psi_angles</strong> : (NR, 1) Los ángulos psi.</p></li>
<li><p><strong>psi_mask</strong> : (NR, 1) Máscara para psi_angles.</p></li>
<li><p><strong>residuo_index</strong> : (NR, 1) Índice de cada residuo de 0 a NR - 1. Ver más abajo.</p></li>
<li><p><strong>resolution</strong> : La resolución de la estructura de la proteína.</p></li>
<li><p><strong>reweighted_profile</strong> : (NR, 22) Perfil donde las secuencias se vuelven a ponderar para ponderar más las secuencias más raras. Vea abajo.</p></li>
<li><p><strong>sec_structure</strong> : (NR, 8) Estructura secundaria generada por DSSP y codificada one-hot por el mapeo -HETSGBI -&gt; range(8).</p></li>
<li><p><strong>sec_structure_mask</strong> : (NR, 1) Máscara para sec_structure_mask.</p></li>
<li><p><strong>seq_length</strong> : (NR, 1) La longitud de la secuencia de aminoácidos. Tiene que ser repetido NR veces. Vea abajo.</p></li>
<li><p><strong>sequence</strong> : La secuencia de aminoácidos (codificación de aminoácidos de 1 letra). Vea abajo.</p></li>
<li><p><strong>solv_surf</strong> : (NR, 1) Área relativa accesible al solvente calculada usando DSSP y luego normalizada por la accesibilidad máxima de aminoácidos.</p></li>
<li><p><strong>solv_surf_mask</strong> : (NR, 1) Máscara para solv_surf.</p></li>
<li><p><strong>superfamily</strong> : El código CATH de la superfamilia.</p></li>
</ul>
<p>Para más detalle:</p>
<p>https://github.com/deepmind/deepmind-research/blob/master/alphafold_casp13/README.md</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span>

<span class="n">NUM_RES</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">FEATURES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;aatype&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">21</span><span class="p">]),</span>
    <span class="s1">&#39;alpha_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;alpha_positions&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
    <span class="s1">&#39;beta_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;beta_positions&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
    <span class="s1">&#39;between_segment_residues&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;chain_name&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;deletion_probability&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;domain_name&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;gap_matrix&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;hhblits_profile&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">22</span><span class="p">]),</span>
    <span class="s1">&#39;hmm_profile&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">30</span><span class="p">]),</span>
    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;mutual_information&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;non_gapped_profile&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">21</span><span class="p">]),</span>
    <span class="s1">&#39;num_alignments&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;num_effective_alignments&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;phi_angles&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;phi_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">21</span><span class="p">]),</span>
    <span class="s1">&#39;profile_with_prior&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">22</span><span class="p">]),</span>
    <span class="s1">&#39;profile_with_prior_without_gaps&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">21</span><span class="p">]),</span>
    <span class="s1">&#39;pseudo_bias&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">22</span><span class="p">]),</span>
    <span class="s1">&#39;pseudo_frob&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;pseudolikelihood&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">484</span><span class="p">]),</span>
    <span class="s1">&#39;psi_angles&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;psi_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;residue_index&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;reweighted_profile&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">22</span><span class="p">]),</span>
    <span class="s1">&#39;sec_structure&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">8</span><span class="p">]),</span>
    <span class="s1">&#39;sec_structure_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;seq_length&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;solv_surf&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;solv_surf_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">NUM_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="s1">&#39;superfamily&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
<span class="p">}</span>
<span class="n">Protein</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Protein&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">,</span> <span class="s1">&#39;seq&#39;</span><span class="p">,</span> <span class="s1">&#39;inputs_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;inputs_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;inputs_2d_diagonal&#39;</span><span class="p">,</span> <span class="s1">&#39;scalars&#39;</span><span class="p">,</span> <span class="s1">&#39;targets&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="lectura-de-los-ficheros-tfrec-pkl-y-config">
<h3>Lectura de los ficheros tfrec, pkl y config<a class="headerlink" href="#lectura-de-los-ficheros-tfrec-pkl-y-config" title="Link to this heading">#</a></h3>
<p>La función <strong>tfrec_read</strong> necesita la librería TensorFlow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install tensorflow</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tfrec_read</span><span class="p">(</span><span class="n">tfrec_file</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CPP_MIN_LOG_LEVEL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;aatype&#39;</span><span class="p">,</span>
        <span class="s1">&#39;beta_mask&#39;</span><span class="p">,</span>
        <span class="s1">&#39;beta_positions&#39;</span><span class="p">,</span>
        <span class="s1">&#39;between_segment_residues&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chain_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;deletion_probability&#39;</span><span class="p">,</span>
        <span class="s1">&#39;domain_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gap_matrix&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hhblits_profile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hmm_profile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;non_gapped_profile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;num_alignments&#39;</span><span class="p">,</span>
        <span class="s1">&#39;num_effective_alignments&#39;</span><span class="p">,</span>
        <span class="s1">&#39;profile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;profile_with_prior&#39;</span><span class="p">,</span>
        <span class="s1">&#39;profile_with_prior_without_gaps&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pseudo_bias&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pseudo_frob&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pseudolikelihood&#39;</span><span class="p">,</span>
        <span class="s1">&#39;residue_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;resolution&#39;</span><span class="p">,</span>
        <span class="s1">&#39;reweighted_profile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sec_structure&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sec_structure_mask&#39;</span><span class="p">,</span>
        <span class="s1">&#39;seq_length&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sequence&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solv_surf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solv_surf_mask&#39;</span><span class="p">,</span>
        <span class="s1">&#39;superfamily&#39;</span>
    <span class="p">]</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">FEATURES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">features</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">parse_tfexample</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="n">feature_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenSequenceFeature</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tf.</span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">allow_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">parsed_features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">)</span>
        <span class="n">num_residues</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">parsed_features</span><span class="p">[</span><span class="s1">&#39;seq_length&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parsed_features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_residues</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">FEATURES</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

            <span class="n">assert_non_empty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">assert_greater</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;assert_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_non_empty&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;The feature </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> is not set in the tf.Example. Either do not &#39;</span>
                <span class="s1">&#39;request the feature or use a tf.Example that has the feature set.&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">control_dependencies</span><span class="p">([</span><span class="n">assert_non_empty</span><span class="p">]):</span>
                <span class="n">parsed_features</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;reshape_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parsed_features</span>

    <span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">([</span><span class="n">tfrec_file</span><span class="p">])</span>
    <span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">raw_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">raw</span><span class="p">:</span> <span class="n">parse_tfexample</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">features</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">raw_dataset</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tfrec2pkl</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">pkl_file</span><span class="p">):</span>
    <span class="n">datalist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;domain_name&#39;</span><span class="p">,</span> <span class="s1">&#39;chain_name&#39;</span><span class="p">,</span> <span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;superfamily&#39;</span><span class="p">,</span> <span class="s1">&#39;num_effective_alignments&#39;</span><span class="p">]:</span>
                <span class="c1"># print(f&quot;{k}: {v.numpy()[0,0].decode(&#39;utf-8&#39;)}&quot;)</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># print(k, v.numpy().shape)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">datalist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkl_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">datalist</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">datalist</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="k">def</span> <span class="nf">build_config</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">replica</span><span class="p">):</span>
    <span class="c1">#config_file = model_path / replica / &#39;config.json&#39;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">replica</span><span class="p">),</span> <span class="s1">&#39;config.json&#39;</span><span class="p">)</span>
    <span class="c1">#stats_file = model_path / &#39;stats_train_s35.json&#39;</span>
    <span class="n">stats_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span><span class="s1">&#39;stats_train_s35.json&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stats_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">norm_stats</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;torsion_multiplier&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;collapsed_batch_norm&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;filters_1d&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;is_ca_feature&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_stats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_stats</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;network_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;network_config&#39;</span><span class="p">]}</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="n">norm_stats</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">make_nt</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">namedtuple</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">make_nt</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

    <span class="k">return</span> <span class="n">make_nt</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">save_seq_prob</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
    <span class="n">SECONDARY_STRUCTURES</span> <span class="o">=</span> <span class="s1">&#39;-HETSGBI&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">L</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;asa&#39;</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;secstruct&#39;</span>

    <span class="k">with</span> <span class="n">out_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# LABEL </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> CLASSES [</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SECONDARY_STRUCTURES</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span><span class="si">}</span><span class="s2">]</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="n">SECONDARY_STRUCTURES</span><span class="p">[</span><span class="n">prob</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">1s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ss</span><span class="si">:</span><span class="s2">1s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%6.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">p</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">prob</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="dibujo-de-distogramas">
<h3>Dibujo de distogramas<a class="headerlink" href="#dibujo-de-distogramas" title="Link to this heading">#</a></h3>
<p>Se dibujan los distogramas del modelo</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_contact_map</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">mats</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mats</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">mats</span><span class="p">),</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mats</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">64</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues_r</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;contact&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="funcion-de-carga-de-datos-dataset">
<h3>Función de carga de datos (Dataset)<a class="headerlink" href="#funcion-de-carga-de-datos-dataset" title="Link to this heading">#</a></h3>
<p>Desde los ficheros se obtiene el <strong>Dataset</strong>, una estructura de tensores con los datos de entrada</p>
<p>El <strong>dataset</strong> es un objeto (creado con una clase de usuario) de conjunto de datos desde el que cargar datos. PyTorch admite dos tipos diferentes de conjuntos de datos:</p>
<ul class="simple">
<li><p><strong>map-style</strong> datasets,</p></li>
<li><p><strong>iterable-style</strong> datasets.</p></li>
</ul>
<p>El dataset <strong>Map-style</strong> es un conjunto de datos de estilo mapa, que está implementado con los protocolos <strong>getitem</strong>() y <strong>len</strong>() , y representa un mapa de índices / claves (posiblemente no integrales) a muestras de datos.</p>
<p>Por ejemplo, accediendo con dataset[idx] , podría leer la imagen idx-th y su etiqueta correspondiente de una carpeta en el disco.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">replica</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tfrec&#39;</span><span class="p">):</span>
        <span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">tfrec_read</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
        <span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">tfrec2pkl</span><span class="p">(</span><span class="n">raw_dataset</span><span class="p">,</span> <span class="n">data_file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;pkl&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">config</span> <span class="o">=</span> <span class="n">build_config</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="c1">#print(&quot;config&quot;, config)</span>
        <span class="n">feature_normalization</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">feature_normalization</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">features</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">normalization_exclusion</span><span class="p">}</span>
        <span class="n">copy_unnormalized</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">targets</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">copy_unnormalized</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_unnormalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        
        <span class="n">range_epsilon</span> <span class="o">=</span> <span class="mf">1e-12</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">feature_normalization</span> <span class="ow">or</span> <span class="n">feature_normalization</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">feature_normalization</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span>
                <span class="n">train_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">norm_stats</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">norm_stats</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">train_range</span> <span class="k">if</span> <span class="n">train_range</span> <span class="o">&gt;</span> <span class="n">range_epsilon</span> <span class="k">else</span> <span class="n">v</span>
                <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown normalization mode </span><span class="si">{</span><span class="n">feature_normalization</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1"> for feature </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span><span class="n">normalize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">raw_dataset</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">convert_to_input</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">tensors_1d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tensors_2d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tensors_2d_diagonal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>

        <span class="n">desired_features</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">features</span>
        <span class="n">desired_scalars</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">scalars</span>
        <span class="n">desired_targets</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">targets</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">desired_features</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">FEATURES</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tensors_1d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_cropped&#39;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_diagonal&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
                      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                          <span class="sa">f</span><span class="s1">&#39;The 2D feature </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> is not in the features dictionary and neither are its cropped and diagonal versions.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                      <span class="n">tensors_2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_cropped&#39;</span><span class="p">]))</span>
                      <span class="n">tensors_2d_diagonal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_diagonal&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tensors_2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>

        <span class="n">inputs_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tensors_1d</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">is_ca_feature</span><span class="p">:</span>
            <span class="c1"># The background model is not conditioned on the sequence</span>
            <span class="c1"># a binary feature δαβ to indicate whether the residue is a glycine (Cα atom) or not (Cβ)</span>
            <span class="n">inputs_1d</span> <span class="o">=</span> <span class="n">inputs_1d</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">inputs_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tensors_2d</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">tensors_2d</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">tensors_2d_diagonal</span><span class="p">:</span>
            <span class="n">diagonal_crops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors_2d_diagonal</span><span class="p">]</span>
            <span class="n">diagonal_crops2</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors_2d_diagonal</span><span class="p">]</span>
            <span class="n">inputs_2d_diagonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">diagonal_crops1</span> <span class="o">+</span> <span class="n">diagonal_crops2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputs_2d_diagonal</span> <span class="o">=</span> <span class="n">inputs_2d</span>

        <span class="n">scalars</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ScalarClass&#39;</span><span class="p">,</span> <span class="n">desired_scalars</span><span class="p">)(</span><span class="o">*</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_unnormalized&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">desired_scalars</span><span class="p">])</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;TargetClass&#39;</span><span class="p">,</span> <span class="n">desired_targets</span><span class="p">)(</span><span class="o">*</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_unnormalized&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">desired_targets</span><span class="p">])</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">Protein</span><span class="p">(</span>
            <span class="nb">len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]),</span>
            <span class="n">seq</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">],</span>
            <span class="n">inputs_1d</span><span class="o">=</span><span class="n">inputs_1d</span><span class="p">,</span>
            <span class="n">inputs_2d</span><span class="o">=</span><span class="n">inputs_2d</span><span class="p">,</span>
            <span class="n">inputs_2d_diagonal</span><span class="o">=</span><span class="n">inputs_2d_diagonal</span><span class="p">,</span>
            <span class="n">scalars</span><span class="o">=</span><span class="n">scalars</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_to_input</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dataset</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ProteinDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">replica</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>El resultado que se obtiene en el <strong>dataset</strong> es un objeto <strong>Protein</strong> con los siguientes atributos:</p>
<ul class="simple">
<li><p><strong>len</strong>: número entero con la longitud de la secuencia de aminoacidos de la proteina</p></li>
<li><p><strong>seq</strong>: secuencia de las letras de los aminoacidos de la proteina..</p></li>
<li><p><strong>inputs_1d</strong></p></li>
<li><p><strong>inputs_2d</strong>:</p></li>
<li><p><strong>inputs_2d_diagonal</strong>:</p></li>
<li><p><strong>scalars</strong>: objeto con valores <strong>num_effective_alignments</strong> y <strong>resolution</strong>.</p></li>
<li><p><strong>targets</strong>: objeto con arrays <strong>sec_structure</strong>, <strong>sec_structure_mask</strong>, <strong>solv_surf</strong>, <strong>solv_surf_mask</strong>, <strong>beta_positions</strong>, <strong>beta_mask</strong>, <strong>num_alignments</strong>, <strong>profile</strong>, <strong>residue_index</strong> y <strong>between_segment_residues</strong> y variables <strong>domain_name</strong>, <strong>chain_name</strong>, <strong>superfamily</strong> y <strong>resolution</strong></p></li>
</ul>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">feature_1d_to_2d</span><span class="p">(</span><span class="n">x_1d</span><span class="p">,</span> <span class="n">res_idx</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">,</span> <span class="n">crop_y</span><span class="p">,</span> <span class="n">crop_size_x</span><span class="p">,</span> <span class="n">crop_size_y</span><span class="p">,</span> <span class="n">binary_code_bits</span><span class="p">):</span>
    <span class="n">res_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">res_idx</span><span class="p">)</span>
    <span class="n">n_x</span><span class="p">,</span> <span class="n">n_y</span> <span class="o">=</span> <span class="n">crop_size_x</span><span class="p">,</span> <span class="n">crop_size_y</span>
    <span class="n">range_scale</span> <span class="o">=</span> <span class="mf">100.0</span>
    <span class="n">x_1d_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">x_1d</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">crop_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="n">crop_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">crop_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_y</span> <span class="o">-</span> <span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="n">crop_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="p">)</span> <span class="c1"># LxD</span>
    <span class="n">range_n_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">res_idx</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">crop_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="n">crop_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">crop_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_y</span> <span class="o">-</span> <span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="n">crop_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>
    <span class="p">)</span> <span class="c1"># L</span>
    <span class="n">x_1d_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">x_1d</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="n">crop_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> 
        <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">crop_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_x</span> <span class="o">-</span> <span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="n">crop_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="p">)</span> <span class="c1"># LxD</span>
    <span class="n">range_n_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">res_idx</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="n">crop_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">crop_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_x</span> <span class="o">-</span> <span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="n">crop_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>
    <span class="p">)</span> <span class="c1"># L</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">range_n_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">range_n_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">range_scale</span> <span class="c1"># LxL</span>
    <span class="n">position_features</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">range_n_y</span><span class="p">)</span> <span class="o">-</span> <span class="n">range_scale</span><span class="p">)</span> <span class="o">/</span> <span class="n">range_scale</span><span class="p">,</span> <span class="p">[</span><span class="n">n_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="p">[</span><span class="n">n_y</span><span class="p">,</span> <span class="n">n_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">binary_code_bits</span><span class="p">:</span>
        <span class="n">exp_range_n_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">range_n_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bin_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">exp_range_n_y</span> <span class="o">//</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">binary_code_bits</span><span class="p">)],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">exp_range_n_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">range_n_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bin_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">exp_range_n_y</span> <span class="o">//</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">binary_code_bits</span><span class="p">)],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">position_features</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">bin_y</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">bin_x</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">[</span><span class="n">n_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="n">augmentation_features</span> <span class="o">=</span> <span class="n">position_features</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x_1d_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">[</span><span class="n">n_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x_1d_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="n">augmentation_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">augmentation_features</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">augmentation_features</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_crops</span><span class="p">(</span><span class="n">inputs_1d</span><span class="p">,</span> <span class="n">inputs_2d</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">res_idx</span><span class="p">,</span> <span class="n">crop_size_x</span><span class="p">,</span> <span class="n">crop_step_x</span><span class="p">,</span> <span class="n">crop_size_y</span><span class="p">,</span> <span class="n">crop_step_y</span><span class="p">,</span> <span class="n">binary_code_bits</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">crop_size_x</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">L</span> <span class="o">-</span> <span class="n">crop_size_x</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">crop_step_x</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">crop_size_y</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">L</span> <span class="o">-</span> <span class="n">crop_size_y</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">crop_step_y</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            start                                                   end</span>
<span class="sd">            |                                                       |</span>
<span class="sd">            i              crop_size_x               end_x          i                                        end_x</span>
<span class="sd">            |----------------------------------------|              |----------------------------------------|</span>
<span class="sd">            ....................KVEPVGNAYGHWTKHGKEFPEYQNAKQYVDAAHNFMTNPPLTNPPPGTLTKTRPNGD.....................</span>
<span class="sd">            |___________________|________________________________________|              |____________________|</span>
<span class="sd">                  prepad_x      0              crop_size_x                              L      postpad_x</span>
<span class="sd">                                ic</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">end_x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">crop_size_x</span>
            <span class="n">end_y</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">crop_size_y</span>
            <span class="n">crop_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">end_x</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">crop_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">j</span><span class="p">,</span> <span class="n">end_y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">jc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
            <span class="n">end_x_cropped</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">end_x</span><span class="p">)</span>
            <span class="n">end_y_cropped</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">end_y</span><span class="p">)</span>
            <span class="n">prepad_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">i</span><span class="p">)</span>
            <span class="n">prepad_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">j</span><span class="p">)</span>
            <span class="n">postpad_x</span> <span class="o">=</span> <span class="n">end_x</span> <span class="o">-</span> <span class="n">end_x_cropped</span>
            <span class="n">postpad_y</span> <span class="o">=</span> <span class="n">end_y</span> <span class="o">-</span> <span class="n">end_y_cropped</span>

            <span class="n">cyx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
                <span class="n">inputs_2d</span><span class="p">[</span><span class="n">jc</span><span class="p">:</span><span class="n">end_y</span><span class="p">,</span> <span class="n">ic</span><span class="p">:</span><span class="n">end_x</span><span class="p">,</span> <span class="p">:],</span>
                <span class="p">[[</span><span class="n">prepad_y</span><span class="p">,</span> <span class="n">postpad_y</span><span class="p">],</span>
                <span class="p">[</span><span class="n">prepad_x</span><span class="p">,</span> <span class="n">postpad_x</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">cyx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">crop_size_y</span>
            <span class="k">assert</span> <span class="n">cyx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">crop_size_x</span>

            <span class="n">cxx</span> <span class="o">=</span> <span class="n">inputs_2d</span><span class="p">[</span><span class="n">ic</span><span class="p">:</span><span class="n">end_x</span><span class="p">,</span> <span class="n">ic</span><span class="p">:</span><span class="n">end_x</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">cxx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cyx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">cxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">cxx</span><span class="p">,</span>
                    <span class="p">[[</span><span class="n">prepad_x</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">crop_size_y</span> <span class="o">-</span> <span class="n">L</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">prepad_x</span><span class="p">,</span> <span class="n">postpad_x</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                <span class="p">)</span>
            <span class="k">assert</span> <span class="n">cxx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">crop_size_y</span>
            <span class="k">assert</span> <span class="n">cxx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">crop_size_x</span>

            <span class="n">cyy</span> <span class="o">=</span> <span class="n">inputs_2d</span><span class="p">[</span><span class="n">jc</span><span class="p">:</span><span class="n">end_y</span><span class="p">,</span> <span class="n">jc</span><span class="p">:</span><span class="n">end_y</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">cyy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cyx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">cyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">cyy</span><span class="p">,</span>
                    <span class="p">[[</span><span class="n">prepad_y</span><span class="p">,</span> <span class="n">postpad_y</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">prepad_y</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">crop_size_x</span> <span class="o">-</span> <span class="n">L</span><span class="p">)],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                <span class="p">)</span>
            <span class="k">assert</span> <span class="n">cyy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">crop_size_y</span>
            <span class="k">assert</span> <span class="n">cyy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">crop_size_x</span>

            <span class="n">augmentation_features</span> <span class="o">=</span> <span class="n">feature_1d_to_2d</span><span class="p">(</span><span class="n">inputs_1d</span><span class="p">,</span> <span class="n">res_idx</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">,</span> <span class="n">crop_y</span><span class="p">,</span> <span class="n">crop_size_x</span><span class="p">,</span> <span class="n">crop_size_y</span><span class="p">,</span> <span class="n">binary_code_bits</span><span class="p">)</span> <span class="c1"># LxLxD1</span>
            <span class="n">x_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">cyx</span><span class="p">,</span> <span class="n">cxx</span><span class="p">,</span> <span class="n">cyy</span><span class="p">,</span> <span class="n">augmentation_features</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># LxLx(3D2+D1)</span>
            <span class="k">yield</span> <span class="n">x_2d</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">,</span> <span class="n">crop_y</span>

<span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">protein</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">crops</span> <span class="o">=</span> <span class="n">make_crops</span><span class="p">(</span><span class="n">protein</span><span class="o">.</span><span class="n">inputs_1d</span><span class="p">,</span>
                       <span class="n">protein</span><span class="o">.</span><span class="n">inputs_2d</span><span class="p">,</span>
                       <span class="n">protein</span><span class="o">.</span><span class="n">len</span><span class="p">,</span>
                       <span class="n">protein</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">residue_index</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                       <span class="n">config</span><span class="o">.</span><span class="n">crop_size_x</span><span class="p">,</span>
                       <span class="n">config</span><span class="o">.</span><span class="n">crop_size_x</span> <span class="o">//</span> <span class="n">config</span><span class="o">.</span><span class="n">eval_config</span><span class="o">.</span><span class="n">crop_shingle_x</span><span class="p">,</span>
                       <span class="n">config</span><span class="o">.</span><span class="n">crop_size_y</span><span class="p">,</span>
                       <span class="n">config</span><span class="o">.</span><span class="n">crop_size_y</span> <span class="o">//</span> <span class="n">config</span><span class="o">.</span><span class="n">eval_config</span><span class="o">.</span><span class="n">crop_shingle_y</span><span class="p">,</span>
                       <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">binary_code_bits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">protein</span><span class="p">,</span> <span class="n">crops</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>En el momento de construir el <strong>dataloader</strong> se asigna la función <strong>collate_fn</strong> desde el constructor del objeto <strong>DataLoader</strong>.</p>
<p>En el momento que se recuperan las proteinas se ejecuta la función <strong>collate_fn</strong> se generan los cultivos (<strong>crops</strong>) asociados a cada proteina.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ProteinDataLoader</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">replica</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">ProteinDataset</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">build_config</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span>
    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">collate_fn</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">config</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dataloader</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="se-cargan-los-datos-disponibles">
<h3>Se cargan los datos disponibles<a class="headerlink" href="#se-cargan-los-datos-disponibles" title="Link to this heading">#</a></h3>
<p>Una versión completa de la base de datos <strong>CASP13</strong> se encuentra en  (45 GB en ZIP):</p>
<p>http://bit.ly/alphafold-casp13-data</p>
<p>En el aparecen 72 estructuras de proteinas, denominadas de acuerdo al nombre del subdirectorio, desde <strong>T0949</strong>, <strong>T0953s1</strong>, <strong>…</strong>, hasta <strong>T1022s2</strong>. Así los <strong>IDs de las proteinas</strong> serán: <strong>{T0949, T0953s1. …, T1022s2}</strong>.</p>
<p>En cada uno de los subdirectorios aparece un fichero de con nombre el <strong>ID</strong> y extensión <strong>tfrec</strong> y un subdirectorio <strong>contacts</strong> que tiene dos ficheros de extensión <strong>pickle</strong> y <strong>rr</strong>.</p>
<p>En este cuaderno se utiliza el modelo de datos que se explica en</p>
<p>https://github.com/Urinx/alphafold_pytorch/blob/master/README.md</p>
<p>Y que aparece contenido en el zip:</p>
<p>https://drive.google.com/file/d/1oLJS_7udqBOQr1gLGZY-ui8emenZzyj4/view</p>
<p>En concreto la proteina disponible es: <strong>T1019s2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">googleColaboratory</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">DISTOGRAM_MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;873731&#39;</span><span class="p">)</span>
<span class="n">replica</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">tfrec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;T1019s2&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;T1019s2.tfrec&#39;</span><span class="p">)</span>
<span class="c1">#dataset = ProteinDataset(tfrec_path , DISTOGRAM_MODEL, replica)</span>
<span class="c1">#dataloader = DataLoader(dataset, batch_size=1, collate_fn=collate_fn)</span>

<span class="n">dataloader</span> <span class="o">=</span> <span class="n">ProteinDataLoader</span><span class="p">(</span><span class="n">tfrec_path</span><span class="p">,</span> <span class="n">DISTOGRAM_MODEL</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From C:\Users\valer_z\anaconda3\Lib\site-packages\keras\src\losses.py:2976: The name tf.losses.sparse_softmax_cross_entropy is deprecated. Please use tf.compat.v1.losses.sparse_softmax_cross_entropy instead.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">crops</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">protein</span><span class="o">.</span><span class="n">len</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Protein: &#39;</span><span class="p">,</span><span class="n">protein</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">domain_name</span><span class="p">,</span> <span class="s1">&#39; -Seq: &#39;</span><span class="p">,</span> <span class="n">protein</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="s1">&#39; -Len:&#39;</span><span class="p">,</span> <span class="n">protein</span><span class="o">.</span><span class="n">len</span><span class="p">)</span>
        <span class="n">n_cr</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">,</span> <span class="n">crop_y</span> <span class="ow">in</span> <span class="n">crops</span><span class="p">:</span>
            <span class="n">n_cr</span> <span class="o">+=</span><span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total crops=&#39;</span><span class="p">,</span> <span class="n">n_cr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Protein:  T1019s2-l64_s24  -Seq:  AKQYVDAAHNFMTNPPPGTLTKTRPNGDTLYYNPVTNVFASKDINGVPRTMFKPEKGIEYWNKQ  -Len: 64
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total crops= 256
Protein:  T1019s2-l64_s0  -Seq:  KVEPVGNAYGHWTKHGKEFPEYQNAKQYVDAAHNFMTNPPPGTLTKTRPNGDTLYYNPVTNVFA  -Len: 64
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total crops= 256
Protein:  T1019s2  -Seq:  KVEPVGNAYGHWTKHGKEFPEYQNAKQYVDAAHNFMTNPPPGTLTKTRPNGDTLYYNPVTNVFASKDINGVPRTMFKPEKGIEYWNKQ  -Len: 88
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total crops= 484
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="definicion-del-modelo">
<h2>Definición del Modelo<a class="headerlink" href="#definicion-del-modelo" title="Link to this heading">#</a></h2>
<a class="reference internal image-reference" href="_images/alphafold_net3.png"><img alt="_images/alphafold_net3.png" src="_images/alphafold_net3.png" style="width: 700px;" /></a>
<p>Un <strong>esquema del sistema de plegado</strong>.</p>
<p><strong>(a)</strong> Las etapas de extracción de características se muestran en amarillo, la red neuronal de predicción de estructuras en verde, la construcción potencial en rojo y la realización de estructuras en azul.</p>
<p><strong>(b)</strong> Las capas utilizadas en un bloque de la <strong>red convolucional residual</strong> profunda. La salida del bloque se suma a la representación de la capa anterior. Las conexiones de derivación de la red residual permiten que los gradientes vuelvan a pasar a través de la red sin disminuir, lo que permite el entrenamiento de redes muy profundas.</p>
<section id="capa-de-convoluciones-que-se-inserta-en-los-bloques-residuales">
<h3>Capa de convoluciones que se inserta en los bloques residuales<a class="headerlink" href="#capa-de-convoluciones-que-se-inserta-en-los-bloques-residuales" title="Link to this heading">#</a></h3>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">namedtuple</span>

<span class="k">def</span> <span class="nf">make_conv_layer</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span>
                    <span class="n">out_channels</span><span class="p">,</span>
                    <span class="n">filter_size</span><span class="p">,</span>
                    <span class="n">non_linearity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">atrou_rate</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">filter_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">padding_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">filter_size</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">padding_size</span> <span class="o">=</span> <span class="n">atrou_rate</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="n">batch_norm</span><span class="p">:</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">filter_size</span><span class="p">,</span>
                               <span class="n">padding</span><span class="o">=</span><span class="n">padding_size</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="n">atrou_rate</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_channels</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">filter_size</span><span class="p">,</span>
                               <span class="n">padding</span><span class="o">=</span><span class="n">padding_size</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="n">atrou_rate</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">non_linearity</span><span class="p">:</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;elu&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ELU</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">make_conv_sep2d_layer</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span>
                          <span class="n">out_channels</span><span class="p">,</span>
                          <span class="n">channel_multiplier</span><span class="p">,</span>
                          <span class="n">filter_size</span><span class="p">,</span>
                          <span class="n">filter_size_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">atrou_rate</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use separable convolutions.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="bloque-de-capas-residuales">
<h3>Bloque de capas residuales<a class="headerlink" href="#bloque-de-capas-residuales" title="Link to this heading">#</a></h3>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ResidualBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span>
                       <span class="n">out_channels</span><span class="p">,</span>
                       <span class="n">layer_name</span><span class="p">,</span>
                       <span class="n">filter_size</span><span class="p">,</span>
                       <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">divide_channels_by</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                       <span class="n">atrou_rate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">channel_multiplier</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                       <span class="n">dropout_keep_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A separable resnet block.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_norm</span> <span class="o">=</span> <span class="n">batch_norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_keep_prob</span> <span class="o">=</span> <span class="n">dropout_keep_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_multiplier</span> <span class="o">=</span> <span class="n">channel_multiplier</span>

        <span class="k">if</span> <span class="n">batch_norm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ELU</span><span class="p">()</span>

        <span class="c1"># 1x1 with half size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_1x1h</span> <span class="o">=</span> <span class="n">make_conv_layer</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span>
                                         <span class="n">out_channels</span><span class="o">=</span><span class="n">in_channels</span> <span class="o">//</span> <span class="n">divide_channels_by</span><span class="p">,</span>
                                         <span class="n">filter_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">non_linearity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">batch_norm</span><span class="o">=</span><span class="n">batch_norm</span><span class="p">)</span>

        <span class="c1"># 3x3 with half size</span>
        <span class="k">if</span> <span class="n">channel_multiplier</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv_3x3h</span> <span class="o">=</span> <span class="n">make_conv_layer</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span> <span class="o">//</span> <span class="n">divide_channels_by</span><span class="p">,</span>
                                             <span class="n">out_channels</span><span class="o">=</span><span class="n">in_channels</span> <span class="o">//</span> <span class="n">divide_channels_by</span><span class="p">,</span>
                                             <span class="n">filter_size</span><span class="o">=</span><span class="n">filter_size</span><span class="p">,</span>
                                             <span class="n">non_linearity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">batch_norm</span><span class="o">=</span><span class="n">batch_norm</span><span class="p">,</span>
                                             <span class="n">atrou_rate</span><span class="o">=</span><span class="n">atrou_rate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv_sep3x3h</span> <span class="o">=</span> <span class="n">make_conv_sep2d_layer</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span> <span class="o">//</span> <span class="n">divide_channels_by</span><span class="p">,</span>
                                                      <span class="n">out_channels</span><span class="o">=</span><span class="n">in_channels</span> <span class="o">//</span> <span class="n">divide_channels_by</span><span class="p">,</span>
                                                      <span class="n">channel_multiplier</span><span class="o">=</span><span class="n">channel_multiplier</span><span class="p">,</span>
                                                      <span class="n">filter_size</span><span class="o">=</span><span class="n">filter_size</span><span class="p">,</span>
                                                      <span class="n">batch_norm</span><span class="o">=</span><span class="n">batch_norm</span><span class="p">,</span>
                                                      <span class="n">atrou_rate</span><span class="o">=</span><span class="n">atrou_rate</span><span class="p">)</span>

        <span class="c1"># 1x1 back to normal size without relu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_1x1</span> <span class="o">=</span> <span class="n">make_conv_layer</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span> <span class="o">//</span> <span class="n">divide_channels_by</span><span class="p">,</span>
                                        <span class="n">out_channels</span><span class="o">=</span><span class="n">out_channels</span><span class="p">,</span>
                                        <span class="n">filter_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">non_linearity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dropout_keep_prob</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">dropout_keep_prob</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_norm</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_1x1h</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_multiplier</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_3x3h</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_sep3x3h</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_1x1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_keep_prob</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_two_dim_resnet</span><span class="p">(</span><span class="n">num_features</span><span class="p">,</span>
                        <span class="n">num_predictions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">num_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                        <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">filter_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">final_non_linearity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">atrou_rates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">channel_multiplier</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">divide_channels_by</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">resize_features_with_1x1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">dropout_keep_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">atrou_rates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">atrou_rates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">non_linearity</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i_layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
        <span class="n">in_channels</span> <span class="o">=</span> <span class="n">num_channels</span>
        <span class="n">out_channels</span> <span class="o">=</span> <span class="n">num_channels</span>
        <span class="n">curr_atrou_rate</span> <span class="o">=</span> <span class="n">atrou_rates</span><span class="p">[</span><span class="n">i_layer</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">atrou_rates</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">i_layer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">in_channels</span> <span class="o">=</span> <span class="n">num_features</span>
        <span class="k">if</span> <span class="n">i_layer</span> <span class="o">==</span> <span class="n">num_layers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out_channels</span> <span class="o">=</span> <span class="n">num_predictions</span>
            <span class="n">non_linearity</span> <span class="o">=</span> <span class="n">final_non_linearity</span>

        <span class="k">if</span> <span class="n">i_layer</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i_layer</span> <span class="o">==</span> <span class="n">num_layers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">layer_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;conv</span><span class="si">{</span><span class="n">i_layer</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">initial_filter_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">resize_features_with_1x1</span> <span class="k">else</span> <span class="n">filter_size</span>
            <span class="n">conv_layer</span> <span class="o">=</span> <span class="n">make_conv_layer</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span>
                                        <span class="n">out_channels</span><span class="o">=</span><span class="n">out_channels</span><span class="p">,</span>
                                        <span class="n">filter_size</span><span class="o">=</span><span class="n">initial_filter_size</span><span class="p">,</span>
                                        <span class="n">non_linearity</span><span class="o">=</span><span class="n">non_linearity</span><span class="p">,</span>
                                        <span class="n">atrou_rate</span><span class="o">=</span><span class="n">curr_atrou_rate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layer_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;res</span><span class="si">{</span><span class="n">i_layer</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">conv_layer</span> <span class="o">=</span> <span class="n">ResidualBlock</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span>
                                       <span class="n">out_channels</span><span class="o">=</span><span class="n">out_channels</span><span class="p">,</span>
                                       <span class="n">layer_name</span><span class="o">=</span><span class="n">layer_name</span><span class="p">,</span>
                                       <span class="n">filter_size</span><span class="o">=</span><span class="n">filter_size</span><span class="p">,</span>
                                       <span class="n">batch_norm</span><span class="o">=</span><span class="n">batch_norm</span><span class="p">,</span>
                                       <span class="n">atrou_rate</span><span class="o">=</span><span class="n">curr_atrou_rate</span><span class="p">,</span>
                                       <span class="n">channel_multiplier</span><span class="o">=</span><span class="n">channel_multiplier</span><span class="p">,</span>
                                       <span class="n">divide_channels_by</span><span class="o">=</span><span class="n">divide_channels_by</span><span class="p">,</span>
                                       <span class="n">dropout_keep_prob</span><span class="o">=</span><span class="n">dropout_keep_prob</span><span class="p">)</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">layer_name</span><span class="p">,</span> <span class="n">conv_layer</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="clase-principal">
<h3>Clase principal<a class="headerlink" href="#clase-principal" title="Link to this heading">#</a></h3>
<p>La predicción se ejecuta desde la función <strong>forward</strong> de la clase principal <strong>ContactsNet</strong>.</p>
<p>Al constructor de <strong>ContactsNet</strong> se le pasa la variable dictionary <strong>config</strong> con el detalle de la configuración.</p>
<p>Se ejecuta una predicción por cada cultivo (<strong>crop</strong>) asociado a la secuencia de la proteina, pasando las variables <strong>x</strong>, <strong>crop_x</strong> y <strong>crop_y</strong> de cada cultivo. Desde <strong>forward</strong> se ejecuta la siguiente secuencia:</p>
<ul class="simple">
<li><p>Se llama a <strong>Deep2DExtra</strong>.</p></li>
<li><p>Se llama a <strong>Deep2D</strong>.</p></li>
</ul>
<p>Ambas funciones llaman a <strong>make_two_dim_resnet</strong> que tiene un objeto <strong>ResidualBlock</strong> que en su proceso <strong>forward</strong> tiene definido un bloque de red residual con el diseño:</p>
<p>ResidualBlock(</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  (bn): BatchNorm2d(256, eps=0.001, momentum=0.001, affine=True, track_running_stats=True)
  
  (elu): ELU(alpha=1.0)
  
  (conv_1x1h): Sequential(
  
    (conv): Conv2d(256, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
    
    (bn): BatchNorm2d(128, eps=0.001, momentum=0.001, affine=True, track_running_stats=True)
    
    (elu): ELU(alpha=1.0)
    
  )
  
  (conv_3x3h): Sequential(
  
    (conv): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(2, 2), dilation=(2, 2), bias=False)
    
    (bn): BatchNorm2d(128, eps=0.001, momentum=0.001, affine=True, track_running_stats=True)
    
    (elu): ELU(alpha=1.0)
    
  )
  
  (conv_1x1): Sequential(
  
    (conv): Conv2d(128, 256, kernel_size=(1, 1), stride=(1, 1))
    
  )
</pre></div>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ContactsNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">network_2d_deep</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">network_2d_deep</span>
        <span class="n">output_dimension</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_bins</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">is_ca_feature</span><span class="p">:</span>
            <span class="n">num_features</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_features</span> <span class="o">=</span> <span class="mi">1878</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quant_threshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">threshold</span> <span class="o">-</span> <span class="n">config</span><span class="o">.</span><span class="n">min_range</span><span class="p">)</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">num_bins</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_range</span><span class="p">))</span>

        <span class="c1"># total 220 residual blocks with dilated convolutions</span>
        <span class="k">if</span> <span class="n">network_2d_deep</span><span class="o">.</span><span class="n">extra_blocks</span><span class="p">:</span>
            <span class="c1"># 7 groups of 4 blocks with 256 channels, cycling through dilations 1,2,4,8.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Deep2DExtra</span> <span class="o">=</span> <span class="n">make_two_dim_resnet</span><span class="p">(</span>
                <span class="n">num_features</span><span class="o">=</span><span class="n">num_features</span><span class="p">,</span>
                <span class="n">num_predictions</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">network_2d_deep</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span>
                <span class="n">num_channels</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">network_2d_deep</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span>
                <span class="n">num_layers</span><span class="o">=</span><span class="n">network_2d_deep</span><span class="o">.</span><span class="n">extra_blocks</span> <span class="o">*</span> <span class="n">network_2d_deep</span><span class="o">.</span><span class="n">num_layers_per_block</span><span class="p">,</span>
                <span class="n">filter_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">batch_norm</span><span class="o">=</span><span class="n">network_2d_deep</span><span class="o">.</span><span class="n">use_batch_norm</span><span class="p">,</span>
                <span class="n">final_non_linearity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">atrou_rates</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
                <span class="n">dropout_keep_prob</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="p">)</span>
            <span class="n">num_features</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">network_2d_deep</span><span class="o">.</span><span class="n">num_filters</span>

        <span class="c1"># 48 groups of 4 blocks with 128 channels, cycling through dilations 1,2,4,8.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Deep2D</span> <span class="o">=</span> <span class="n">make_two_dim_resnet</span><span class="p">(</span>
            <span class="n">num_features</span><span class="o">=</span><span class="n">num_features</span><span class="p">,</span>
            <span class="n">num_predictions</span><span class="o">=</span><span class="n">network_2d_deep</span><span class="o">.</span><span class="n">num_filters</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">reshape_layer</span> <span class="k">else</span> <span class="n">output_dimension</span><span class="p">,</span>
            <span class="n">num_channels</span><span class="o">=</span><span class="n">network_2d_deep</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="n">network_2d_deep</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">*</span> <span class="n">network_2d_deep</span><span class="o">.</span><span class="n">num_layers_per_block</span><span class="p">,</span>
            <span class="n">filter_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">batch_norm</span><span class="o">=</span><span class="n">network_2d_deep</span><span class="o">.</span><span class="n">use_batch_norm</span><span class="p">,</span>
            <span class="n">final_non_linearity</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">reshape_layer</span><span class="p">,</span>
            <span class="n">atrou_rates</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
            <span class="n">dropout_keep_prob</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">reshape_layer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_reshape_1x1h</span> <span class="o">=</span> <span class="n">make_conv_layer</span><span class="p">(</span>
                <span class="n">in_channels</span><span class="o">=</span><span class="n">network_2d_deep</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span>
                <span class="n">out_channels</span><span class="o">=</span><span class="n">output_dimension</span><span class="p">,</span>
                <span class="n">filter_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">non_linearity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">batch_norm</span><span class="o">=</span><span class="n">network_2d_deep</span><span class="o">.</span><span class="n">use_batch_norm</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">position_specific_bias_size</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">position_specific_bias_size</span><span class="p">,</span> <span class="n">output_dimension</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_parameter</span><span class="p">(</span><span class="s1">&#39;position_specific_bias&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">network_2d_deep</span><span class="o">.</span><span class="n">num_filters</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">collapsed_batch_norm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collapsed_batch_norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">filters_1d</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nfil</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">filters_1d</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">collapsed_batch_norm</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                        <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">nfil</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                        <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">nfil</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
                    <span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">nfil</span><span class="p">))</span>
                <span class="n">embed_dim</span> <span class="o">=</span> <span class="n">nfil</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collapsed_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">torsion_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">torsion_logits</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">torsion_bins</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">torsion_bins</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">secstruct_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secstruct</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">asa_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASALogits</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">build_crops_biases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bias_size</span><span class="p">,</span> <span class="n">raw_biases</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">,</span> <span class="n">crop_y</span><span class="p">):</span>
        <span class="n">max_off_diag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">crop_x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">crop_y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="p">(</span><span class="n">crop_y</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">crop_x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">padded_bias_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bias_size</span><span class="p">,</span> <span class="n">max_off_diag</span><span class="p">)</span>

        <span class="n">biases</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">raw_biases</span><span class="p">,</span> <span class="n">raw_biases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">padded_bias_size</span> <span class="o">-</span> <span class="n">bias_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">biases</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">biases</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">biases</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">start_diag</span> <span class="o">=</span> <span class="n">crop_x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">crop_y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">crop_size_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">crop_x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">crop_x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">crop_size_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">crop_y</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">crop_y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">increment</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">crop_size_y</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">crop_x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">row_offsets</span> <span class="o">=</span> <span class="n">start_diag</span> <span class="o">+</span> <span class="n">increment</span>
        <span class="n">row_offsets</span> <span class="o">+=</span> <span class="n">padded_bias_size</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">cropped_biases</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">biases</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">crop_size_x</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">offsets</span>
                <span class="p">],</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">offsets</span> <span class="ow">in</span> <span class="n">row_offsets</span>
            <span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># B*crop_y*crop_x*D</span>
        <span class="n">cropped_biases</span> <span class="o">=</span> <span class="n">cropped_biases</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># B*D*crop_y*crop_x</span>

        <span class="k">return</span> <span class="n">cropped_biases</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">,</span> <span class="n">crop_y</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Deep2DExtra</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">contact_pre_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Deep2D</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">reshape_layer</span><span class="p">:</span>
            <span class="n">contact_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_reshape_1x1h</span><span class="p">(</span><span class="n">contact_pre_logits</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">contact_logits</span> <span class="o">=</span> <span class="n">contact_pre_logits</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">position_specific_bias_size</span><span class="p">:</span>
            <span class="n">biases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_crops_biases</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">position_specific_bias_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_specific_bias</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">,</span> <span class="n">crop_y</span><span class="p">)</span>
            <span class="n">contact_logits</span> <span class="o">+=</span> <span class="n">biases</span> <span class="c1"># BxDxLxL</span>

        <span class="n">contact_logits</span> <span class="o">=</span> <span class="n">contact_logits</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># to NHWC shape</span>
        <span class="n">distance_probs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">contact_logits</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># BxLxLxD</span>
        <span class="n">contact_probs</span> <span class="o">=</span> <span class="n">distance_probs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">quant_threshold</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># BxLxL</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;distance_probs&#39;</span><span class="p">:</span> <span class="n">distance_probs</span><span class="p">,</span>
            <span class="s1">&#39;contact_probs&#39;</span><span class="p">:</span> <span class="n">contact_probs</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">secstruct_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span>
            <span class="n">config</span><span class="o">.</span><span class="n">asa_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span>
            <span class="n">config</span><span class="o">.</span><span class="n">torsion_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">collapse_dim</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">join_dim</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">embedding_1d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">contact_pre_logits</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">collapse_dim</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">contact_pre_logits</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">collapse_dim</span><span class="p">)),</span> <span class="n">join_dim</span><span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">contact_pre_logits</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">collapse_dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">contact_pre_logits</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">collapse_dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="n">join_dim</span><span class="p">)</span>
            <span class="p">),</span> <span class="n">collapse_dim</span><span class="p">)</span> <span class="c1"># Bx2Dx2L</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">collapsed_batch_norm</span><span class="p">:</span>
                <span class="n">embedding_1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed_batch_norm</span><span class="p">(</span><span class="n">embedding_1d</span><span class="p">)</span>

            <span class="n">embedding_1d</span> <span class="o">=</span> <span class="n">embedding_1d</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># Bx2Lx2D</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">filters_1d</span><span class="p">):</span>
                <span class="n">embedding_1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed_embed</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">embedding_1d</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">torsion_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">torsion_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_logits</span><span class="p">(</span><span class="n">embedding_1d</span><span class="p">)</span>
                <span class="n">torsion_output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">torsion_logits</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;torsion_probs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torsion_output</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">secstruct_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sec_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secstruct</span><span class="p">(</span><span class="n">embedding_1d</span><span class="p">)</span>
                <span class="n">sec_output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">sec_logits</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;secstruct_probs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sec_output</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">asa_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">asa_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ASALogits</span><span class="p">(</span><span class="n">embedding_1d</span><span class="p">)</span>
                <span class="n">asa_output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">asa_logits</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;asa_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asa_output</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">get_parameter_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_num</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
        <span class="n">trainable_num</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Total&#39;</span><span class="p">:</span> <span class="n">total_num</span><span class="p">,</span> <span class="s1">&#39;Trainable&#39;</span><span class="p">:</span> <span class="n">trainable_num</span><span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="se-crea-un-objeto-con-el-modelo">
<h3>Se crea un objeto con el modelo<a class="headerlink" href="#se-crea-un-objeto-con-el-modelo" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">googleColaboratory</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;device=&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

<span class="n">DISTOGRAM_MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;873731&#39;</span><span class="p">)</span>
<span class="n">BACKGROUND_MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;916425&#39;</span><span class="p">)</span>
<span class="n">TORSION_MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;941521&#39;</span><span class="p">)</span>
<span class="n">replica</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">build_config</span><span class="p">(</span><span class="n">DISTOGRAM_MODEL</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ContactsNet</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>device= cpu
</pre></div>
</div>
</div>
</div>
</section>
<section id="se-carga-el-modelo-pre-entrenado">
<h3>Se carga el modelo pre-entrenado<a class="headerlink" href="#se-carga-el-modelo-pre-entrenado" title="Link to this heading">#</a></h3>
<p><span id="id5">[<a class="reference internal" href="Bibliografia.html#id65" title="Andrew W Senior, Richard Evans, John Jumper, James Kirkpatrick, Laurent Sifre, Tim Green, Chongli Qin, Augustin Žídek, Alexander WR Nelson, Alex Bridgland, and others. Improved protein structure prediction using potentials from deep learning. Nature, 577(7792):706–710, 2020.">Senior <em>et al.</em>, 2020</a>]</span> publican una serie de modelos ya entrenados para el dataset CASP13 que se pueden encontrar en el enlace:</p>
<p>http://bit.ly/alphafold-casp13-weights</p>
<p>Los pesos y datos de AlphaFold están disponibles para uso no comercial solo bajo los términos de la licencia Creative Commons Attribution-NonCommercial 4.0 International (CC BY-NC 4.0).</p>
<p>Para la ejecución del modelo deben estar localizados en ./data/alphafold/model, correspondiendose cada una de las subcarpetas con:</p>
<ul class="simple">
<li><p><strong>873731</strong>: modelo distograma.</p></li>
<li><p><strong>916425</strong>: modelo backgrownd.</p></li>
<li><p><strong>941521</strong>: modelo torsion.</p></li>
</ul>
<p>Descomentando la sentencia</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>print(model) 
</pre></div>
</div>
<p>Se imprime la estructura de bloques convolucionales del modelo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pathlib</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DISTOGRAM_MODEL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">replica</span><span class="p">),</span> <span class="s1">&#39;model.pt&#39;</span><span class="p">)</span>
<span class="n">model_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

<span class="k">if</span> <span class="n">model_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load Model from model.pt&quot;</span><span class="p">)</span>
    <span class="c1">### print(model)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Load Model from model.pt
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="se-evalua-el-dataset-contra-el-modelo">
<h2>Se evalua el dataset contra el modelo<a class="headerlink" href="#se-evalua-el-dataset-contra-el-modelo" title="Link to this heading">#</a></h2>
<p>Implica un paso forward excluyendo el calculo de la función de pérdida y la optimización</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="k">def</span> <span class="nf">runEvaluaModelo</span><span class="p">():</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;T1019s2&#39;</span><span class="p">,</span> <span class="s1">&#39;out_jupyter&#39;</span><span class="p">)</span>
    <span class="n">num_examples</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_crops</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_bins</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">num_bins</span>
    <span class="n">torsion_bins</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">torsion_bins</span>
    <span class="n">crop_size_x</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">crop_size_x</span>
    <span class="n">crop_size_y</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">crop_size_y</span>
    
    <span class="n">prob_weights</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">eval_config</span><span class="o">.</span><span class="n">pyramid_weights</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">crop_size_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">crop_size_x</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">crop_size_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">crop_size_y</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">prob_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">sx</span><span class="p">)),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">sy</span><span class="p">)))</span>
        <span class="n">prob_weights</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">prob_weights</span><span class="p">)</span>
        <span class="n">prob_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">prob_weights</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">eval_config</span><span class="o">.</span><span class="n">pyramid_weights</span><span class="p">)</span> <span class="c1"># crop_size_x x crop_size_y</span>
    
    <span class="n">start_t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">crops</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">protein</span><span class="o">.</span><span class="n">len</span>
        <span class="c1">#print(&#39;Data: &#39;,protein.targets.domain_name, L)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;protein.seq=&#39;</span><span class="p">,</span> <span class="n">protein</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>
    
        <span class="c1"># Crops</span>
        <span class="n">contact_prob_accum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">distance_prob_accum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">sec_accum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">tor_accum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">torsion_bins</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">asa_accum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">weights_1d_accum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">num_crops_local</span> <span class="o">=</span> <span class="mi">0</span>
    
        <span class="k">for</span> <span class="n">x_2d</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">,</span> <span class="n">crop_y</span> <span class="ow">in</span> <span class="n">crops</span><span class="p">:</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">jc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">crop_y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ic_to</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">jc_to</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">crop_y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">prepad_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">crop_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">prepad_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">crop_y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">postpad_x</span> <span class="o">=</span> <span class="n">crop_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ic_to</span>
            <span class="n">postpad_y</span> <span class="o">=</span> <span class="n">crop_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">jc_to</span>
    
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">x_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x_2d</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># to NCHW shape</span>
                <span class="n">x_2d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_2d</span><span class="p">)])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">crop_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">crop_x</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">crop_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">crop_y</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x_2d</span><span class="p">,</span> <span class="n">crop_x</span><span class="p">,</span> <span class="n">crop_y</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
            <span class="n">contact_probs</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;contact_probs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span>
                                                 <span class="n">prepad_y</span><span class="p">:</span><span class="n">crop_size_y</span> <span class="o">-</span> <span class="n">postpad_y</span><span class="p">,</span>
                                                 <span class="n">prepad_x</span><span class="p">:</span><span class="n">crop_size_x</span> <span class="o">-</span> <span class="n">postpad_x</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">distance_probs</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;distance_probs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">prepad_y</span><span class="p">:</span><span class="n">crop_size_y</span> <span class="o">-</span> <span class="n">postpad_y</span><span class="p">,</span>
                                                   <span class="n">prepad_x</span><span class="p">:</span><span class="n">crop_size_x</span> <span class="o">-</span> <span class="n">postpad_x</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">prob_weights</span><span class="p">[</span><span class="n">prepad_y</span><span class="p">:</span><span class="n">crop_size_y</span> <span class="o">-</span> <span class="n">postpad_y</span><span class="p">,</span>
                                  <span class="n">prepad_x</span><span class="p">:</span><span class="n">crop_size_x</span> <span class="o">-</span> <span class="n">postpad_x</span><span class="p">]</span>
    
            <span class="n">contact_prob_accum</span><span class="p">[</span><span class="n">jc</span><span class="p">:</span><span class="n">jc_to</span><span class="p">,</span> <span class="n">ic</span><span class="p">:</span><span class="n">ic_to</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">contact_probs</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">contact_prob_accum</span><span class="p">[</span><span class="n">jc</span><span class="p">:</span><span class="n">jc_to</span><span class="p">,</span> <span class="n">ic</span><span class="p">:</span><span class="n">ic_to</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>
            <span class="n">distance_prob_accum</span><span class="p">[</span><span class="n">jc</span><span class="p">:</span><span class="n">jc_to</span><span class="p">,</span> <span class="n">ic</span><span class="p">:</span><span class="n">ic_to</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">distance_probs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">weights_1d_accum</span><span class="p">[</span><span class="n">jc</span><span class="p">:</span><span class="n">jc_to</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">weights_1d_accum</span><span class="p">[</span><span class="n">ic</span><span class="p">:</span><span class="n">ic_to</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    
            <span class="k">if</span> <span class="s1">&#39;secstruct_probs&#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">sec_x</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;secstruct_probs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">prepad_x</span><span class="p">:</span><span class="n">crop_size_x</span> <span class="o">-</span> <span class="n">postpad_x</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">sec_y</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;secstruct_probs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">crop_size_x</span> <span class="o">+</span> <span class="n">prepad_y</span><span class="p">:</span><span class="n">crop_size_x</span> <span class="o">+</span> <span class="n">crop_size_y</span> <span class="o">-</span> <span class="n">postpad_y</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">sec_accum</span><span class="p">[</span><span class="n">ic</span><span class="p">:</span><span class="n">ic</span> <span class="o">+</span> <span class="n">sec_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">sec_x</span>
                <span class="n">sec_accum</span><span class="p">[</span><span class="n">jc</span><span class="p">:</span><span class="n">jc</span> <span class="o">+</span> <span class="n">sec_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">sec_y</span>
    
            <span class="k">if</span> <span class="s1">&#39;torsion_probs&#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">tor_x</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;torsion_probs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">prepad_x</span><span class="p">:</span><span class="n">crop_size_x</span> <span class="o">-</span> <span class="n">postpad_x</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">tor_y</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;torsion_probs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">crop_size_x</span> <span class="o">+</span> <span class="n">prepad_y</span><span class="p">:</span><span class="n">crop_size_x</span> <span class="o">+</span> <span class="n">crop_size_y</span> <span class="o">-</span> <span class="n">postpad_y</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">tor_accum</span><span class="p">[</span><span class="n">ic</span><span class="p">:</span><span class="n">ic</span> <span class="o">+</span> <span class="n">tor_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">tor_x</span>
                <span class="n">tor_accum</span><span class="p">[</span><span class="n">jc</span><span class="p">:</span><span class="n">jc</span> <span class="o">+</span> <span class="n">tor_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">tor_y</span>
    
            <span class="k">if</span> <span class="s1">&#39;asa_output&#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">asa_x</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;asa_output&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">prepad_x</span><span class="p">:</span><span class="n">crop_size_x</span> <span class="o">-</span> <span class="n">postpad_x</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">asa_y</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;asa_output&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">crop_size_x</span> <span class="o">+</span> <span class="n">prepad_y</span><span class="p">:</span><span class="n">crop_size_x</span> <span class="o">+</span> <span class="n">crop_size_y</span> <span class="o">-</span> <span class="n">postpad_y</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">asa_accum</span><span class="p">[</span><span class="n">ic</span><span class="p">:</span><span class="n">ic</span> <span class="o">+</span> <span class="n">asa_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">asa_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">asa_accum</span><span class="p">[</span><span class="n">jc</span><span class="p">:</span><span class="n">jc</span> <span class="o">+</span> <span class="n">asa_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">asa_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
            <span class="n">num_crops_local</span> <span class="o">+=</span> <span class="mi">1</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total num_crops_local=&#39;</span><span class="p">,</span> <span class="n">num_crops_local</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">contact_prob_accum</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">contact_accum</span> <span class="o">=</span> <span class="n">contact_prob_accum</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">contact_prob_accum</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">distance_accum</span> <span class="o">=</span> <span class="n">distance_prob_accum</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">contact_prob_accum</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">asa_accum</span> <span class="o">/=</span> <span class="n">weights_1d_accum</span>
        <span class="n">sec_accum</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights_1d_accum</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tor_accum</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights_1d_accum</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># The probs are symmetrical</span>
        <span class="n">contact_accum</span> <span class="o">=</span> <span class="p">(</span><span class="n">contact_accum</span> <span class="o">+</span> <span class="n">contact_accum</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">distance_accum</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance_accum</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">distance_accum</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">2</span>
    
        <span class="c1"># Save the output files (contacts)</span>
        <span class="n">path_contact</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">protein</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">domain_name</span><span class="si">}</span><span class="s1">.contact&#39;</span><span class="p">)</span>
        <span class="n">file_contact</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path_contact</span><span class="p">)</span>
        <span class="n">contact_accum</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">file_contact</span><span class="p">)</span>
        <span class="c1"># Save the output files</span>
        <span class="n">path_distance</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">protein</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">domain_name</span><span class="si">}</span><span class="s1">.distance&#39;</span><span class="p">)</span>
        <span class="n">file_distance</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path_distance</span><span class="p">)</span>
        <span class="n">distance_accum</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">file_distance</span><span class="p">)</span>
        <span class="c1">#distance_accum.dump(out_dir / f&#39;{protein.targets.domain_name}.distance&#39;)</span>
        <span class="n">path_torsion</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">protein</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">domain_name</span><span class="si">}</span><span class="s1">.torsion&#39;</span><span class="p">)</span>
        <span class="n">file_torsion</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path_torsion</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">torsion_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tor_accum</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">file_torsion</span><span class="p">)</span>
            <span class="c1">#tor_accum.dump(out_dir / f&#39;{protein.targets.domain_name}.torsion&#39;)</span>
        <span class="n">path_sec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">protein</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">domain_name</span><span class="si">}</span><span class="s1">.sec&#39;</span><span class="p">)</span>
        <span class="n">file_sec</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path_sec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">secstruct_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#utils.save_seq_prob(sec_accum, protein.seq, out_dir / f&#39;{protein.targets.domain_name}.sec&#39;)</span>
            <span class="n">save_seq_prob</span><span class="p">(</span><span class="n">sec_accum</span><span class="p">,</span> <span class="n">protein</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="n">file_sec</span><span class="p">)</span>
        <span class="n">path_asa</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">protein</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">domain_name</span><span class="si">}</span><span class="s1">.torsion&#39;</span><span class="p">)</span>
        <span class="n">file_asa</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path_torsion</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">network_config</span><span class="o">.</span><span class="n">asa_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#utils.save_seq_prob(asa_accum, protein.seq, out_dir / f&#39;{protein.targets.domain_name}.asa&#39;)</span>
            <span class="n">save_seq_prob</span><span class="p">(</span><span class="n">asa_accum</span><span class="p">,</span> <span class="n">protein</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="n">file_asa</span><span class="p">)</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done dump to distance, torsion sec and asa files!&#39;</span><span class="p">)</span>
    
        <span class="n">num_examples</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">num_crops</span> <span class="o">+=</span> <span class="n">num_crops_local</span>
        <span class="k">if</span> <span class="n">num_examples</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">eval_config</span><span class="o">.</span><span class="n">max_num_examples</span><span class="p">:</span> <span class="k">break</span>
            
    <span class="n">time_spent</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_t</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Evaluate </span><span class="si">{</span><span class="n">num_examples</span><span class="si">}</span><span class="s1"> examples, </span><span class="si">{</span><span class="n">num_crops</span><span class="si">}</span><span class="s1"> crops, </span><span class="si">{</span><span class="n">num_crops</span><span class="o">/</span><span class="n">num_examples</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> crops/ex&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cost time </span><span class="si">{</span><span class="n">time_spent</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">time_spent</span><span class="o">/</span><span class="n">num_examples</span><span class="si">}</span><span class="s1"> s/example, </span><span class="si">{</span><span class="n">time_spent</span><span class="o">/</span><span class="n">num_crops</span><span class="si">}</span><span class="s1"> s/crops</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">modoEvaluacion</span><span class="p">:</span>
    <span class="n">runEvaluaModelo</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;El modo evaluación no está activo!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>El modo evaluación no está activo!
</pre></div>
</div>
</div>
</div>
</section>
<section id="se-dibujan-los-resultados">
<h2>Se dibujan los resultados<a class="headerlink" href="#se-dibujan-los-resultados" title="Link to this heading">#</a></h2>
<p>Se muestran los distogramas obtenidos en la ultima secuencia de la anterior iteración, según quedó guardado en las variables de memoria</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mpimg</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">crops</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
    <span class="n">m_target</span> <span class="o">=</span> <span class="n">protein</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">domain_name</span>
<span class="k">if</span> <span class="n">modoEvaluacion</span><span class="p">:</span>
    <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;T1019s2&#39;</span><span class="p">,</span> <span class="s1">&#39;out_jupyter&#39;</span><span class="p">,</span> <span class="n">m_target</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
    <span class="n">plot_contact_map</span><span class="p">(</span><span class="n">m_target</span><span class="p">,</span> <span class="p">[</span><span class="n">contact_accum</span><span class="p">,</span> <span class="n">distance_accum</span><span class="p">],</span> <span class="n">file_out</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">file_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;T1019s2&#39;</span><span class="p">,</span> <span class="s1">&#39;out_jupyter&#39;</span><span class="p">,</span> <span class="n">m_target</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2408a6a3f3ead2397f73a1d87b6222958d9df845c4b40c7842e78ec01c5d9e4a.png" src="_images/2408a6a3f3ead2397f73a1d87b6222958d9df845c4b40c7842e78ec01c5d9e4a.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="05.07B_RRNN_Convoluciones_Maqueta.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Maqueta de red neuronal convolucional</p>
      </div>
    </a>
    <a class="right-next"
       href="05.09RRNN_PointNet_con_Pytorch.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Identificación 3D con PointNet</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduccion">Introducción</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#alcance-del-cuaderno">Alcance del cuaderno</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creacion-de-datasets-y-dataloaders">Creación de Datasets y Dataloaders</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#definicion-de-las-caracteristicas-del-modelo">Definición de las características del modelo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lectura-de-los-ficheros-tfrec-pkl-y-config">Lectura de los ficheros tfrec, pkl y config</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dibujo-de-distogramas">Dibujo de distogramas</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#funcion-de-carga-de-datos-dataset">Función de carga de datos (Dataset)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#se-cargan-los-datos-disponibles">Se cargan los datos disponibles</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#definicion-del-modelo">Definición del Modelo</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#capa-de-convoluciones-que-se-inserta-en-los-bloques-residuales">Capa de convoluciones que se inserta en los bloques residuales</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bloque-de-capas-residuales">Bloque de capas residuales</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clase-principal">Clase principal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#se-crea-un-objeto-con-el-modelo">Se crea un objeto con el modelo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#se-carga-el-modelo-pre-entrenado">Se carga el modelo pre-entrenado</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#se-evalua-el-dataset-contra-el-modelo">Se evalua el dataset contra el modelo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#se-dibujan-los-resultados">Se dibujan los resultados</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Departamento de Matemática Aplicada
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>